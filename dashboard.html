<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Student App</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h2>📥 Register Student</h2>
        <div class="form-group">
            <input type="text" id="name" placeholder="Enter Name">
            <input type="text" id="roll" placeholder="Enter Roll Number">
        </div>
        <div class="form-buttons">
            <button onclick="registerStudent()" id="registerBtn">Register</button>
            <button onclick="updateStudent()" id="updateBtn" class="hidden">Update</button>
        </div>
        <p id="registerStatus" class="status-message"></p>

        <h2>📋 Registered Students</h2>
        <table id="studentTable" class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Roll Number</th>
                    <th>Registered At</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const apiBase = "https://student-principal-communication.onrender.com";
        const localTimeMap = {};
        let editingRoll = null;

        function fetchStudents() {
            fetch(`${apiBase}/students`)
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById("studentTable").querySelector("tbody");
                    tbody.innerHTML = "";
                    data.forEach(student => {
                        const regTime = localTimeMap[student.roll] || "🕑 Not captured";
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${student.name}</td>
                            <td>${student.roll}</td>
                            <td>${regTime}</td>
                            <td>
                                <button class="edit-btn" onclick="editStudent('${student.name}', '${student.roll}')">Edit</button>
                                <button class="delete-btn" onclick="deleteStudent('${student.roll}')">Delete</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(() => {
                    document.getElementById("registerStatus").innerText = "❌ Failed to load students!";
                });
        }

        function registerStudent() {
            const name = document.getElementById("name").value.trim();
            const roll = document.getElementById("roll").value.trim();
            if (!name || !roll) {
                document.getElementById("registerStatus").innerText = "⚠️ Please enter both name and roll number.";
                return;
            }
            const formData = new FormData();
            formData.append("name", name);
            formData.append("roll", roll);

            fetch(`${apiBase}/register`, { method: "POST", body: formData })
                .then(res => res.json())
                .then(data => {
                    document.getElementById("registerStatus").innerText = data.message || data.error;
                    localTimeMap[roll] = new Date().toLocaleString();
                    fetchStudents();
                    document.getElementById("name").value = "";
                    document.getElementById("roll").value = "";
                })
                .catch(() => {
                    document.getElementById("registerStatus").innerText = "❌ Failed to register student.";
                });
        }

        function deleteStudent(roll) {
            if (!confirm("Are you sure you want to delete this student?")) return;
            fetch(`${apiBase}/delete/${roll}`, { method: "DELETE" })
                .then(res => res.json())
                .then(data => {
                    alert(data.message || data.error);
                    delete localTimeMap[roll];
                    fetchStudents();
                })
                .catch(() => alert("❌ Failed to delete student."));
        }

        function editStudent(name, roll) {
            document.getElementById("name").value = name;
            document.getElementById("roll").value = roll;
            document.getElementById("roll").disabled = true;
            editingRoll = roll;

            document.getElementById("registerBtn").classList.add("hidden");
            document.getElementById("updateBtn").classList.remove("hidden");
        }

        function updateStudent() {
            const name = document.getElementById("name").value.trim();
            const roll = document.getElementById("roll").value.trim();
            if (!name || !roll) {
                document.getElementById("registerStatus").innerText = "⚠️ Please enter both name and roll number.";
                return;
            }
            const formData = new FormData();
            formData.append("name", name);
            formData.append("roll", roll);

            fetch(`${apiBase}/update`, { method: "PUT", body: formData })
                .then(res => res.json())
                .then(data => {
                    document.getElementById("registerStatus").innerText = data.message || data.error;
                    fetchStudents();
                    document.getElementById("name").value = "";
                    document.getElementById("roll").value = "";
                    document.getElementById("roll").disabled = false;

                    document.getElementById("registerBtn").classList.remove("hidden");
                    document.getElementById("updateBtn").classList.add("hidden");
                    editingRoll = null;
                })
                .catch(() => {
                    document.getElementById("registerStatus").innerText = "❌ Failed to update student.";
                });
        }

        window.onload = fetchStudents;
    </script>
</body>
</html>
